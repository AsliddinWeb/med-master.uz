{% extends 'base/base.html' %}
{% load static %}
{% load lesson_tags %}
{% load user_tags %}
{% load quiz_tags %}

{% block title %}{{ lesson.title }} - {{ course.title }}{% endblock %}

{% block meta_description %}{{ lesson.description|truncatewords:30 }}{% endblock %}

{% block content %}
<!-- Medical Lesson Header -->
<div class="bg-gradient-to-br from-teal-600 via-cyan-600 to-blue-600 relative overflow-hidden">
    <!-- Medical Background Pattern -->
    <div class="absolute inset-0 opacity-10">
        <div class="absolute top-10 right-10 animate-pulse">
            <i class="fas fa-heartbeat text-white text-8xl transform rotate-12"></i>
        </div>
        <div class="absolute bottom-10 left-10 animate-pulse" style="animation-delay: 1s;">
            <i class="fas fa-stethoscope text-white text-7xl transform -rotate-12"></i>
        </div>
    </div>

    <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="text-white">
            <!-- Breadcrumb -->
            <nav class="flex items-center space-x-2 text-sm mb-4 text-cyan-100">
                <a href="{% url 'courses:detail' course.id %}" class="hover:text-white transition-colors">
                    {{ course.title|truncatewords:5 }}
                </a>
                <i class="fas fa-chevron-right text-xs"></i>
                <span class="text-white">Dars {{ lesson.order }}</span>
            </nav>

            <!-- Lesson Title -->
            <h1 class="text-3xl md:text-4xl font-bold mb-3 animate-fade-in">
                <i class="fas fa-book-medical mr-3"></i>
                {{ lesson.title }}
            </h1>

            <!-- Lesson Meta -->
            <div class="flex flex-wrap items-center gap-4 text-cyan-100">
                <div class="flex items-center">
                    <i class="fas fa-clock mr-2"></i>
                    <span>{{ lesson.duration_minutes }} daqiqa</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-layer-group mr-2"></i>
                    <span>Dars {{ lesson.order }}/{{ course.lessons.count }}</span>
                </div>
                {% if lesson.is_free %}
                    <span class="px-3 py-1 bg-green-500 bg-opacity-30 rounded-full text-green-100 border border-green-400">
                        <i class="fas fa-unlock mr-1"></i>
                        Bepul Dars
                    </span>
                {% endif %}
                {% if lesson_progress and lesson_progress.is_completed %}
                    <span class="px-3 py-1 bg-white bg-opacity-20 rounded-full border border-white">
                        <i class="fas fa-check-circle mr-1"></i>
                        Tugallangan
                    </span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Video & Content Section -->
            <div class="lg:col-span-2">
                
                <!-- Video Player -->
                {% if lesson.video_url %}
                <div class="bg-black rounded-2xl overflow-hidden shadow-2xl mb-8">
                    <div class="relative aspect-video">
                        <iframe src="{{ lesson.video_url|format_video_url }}"
                                class="absolute inset-0 w-full h-full"
                                frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                allowfullscreen>
                        </iframe>
                    </div>
                    
                    <!-- Video Controls (Custom) -->
                    <div class="bg-gray-900 p-4">
                        <div class="flex items-center justify-between text-white">
                            <div class="flex items-center space-x-4">
                                <button onclick="togglePlay()" class="hover:text-teal-400 transition-colors">
                                    <i class="fas fa-play-circle text-2xl"></i>
                                </button>
                                <button onclick="rewind()" class="hover:text-teal-400 transition-colors">
                                    <i class="fas fa-backward text-lg"></i>
                                </button>
                                <button onclick="forward()" class="hover:text-teal-400 transition-colors">
                                    <i class="fas fa-forward text-lg"></i>
                                </button>
                                <div class="text-sm">
                                    <span id="currentTime">00:00</span> / <span>{{ lesson.duration_minutes|default:"00" }}:00</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <button onclick="toggleFullscreen()" class="hover:text-teal-400 transition-colors">
                                    <i class="fas fa-expand text-lg"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        {% if lesson_progress %}
                        <div class="mt-3">
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div class="bg-gradient-to-r from-teal-500 to-cyan-600 h-2 rounded-full transition-all duration-300"
                                     style="width: {{ user|lesson_watched_percentage:lesson }}%"></div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <!-- No Video Message -->
                <div class="bg-white rounded-2xl shadow-lg p-12 mb-8 text-center">
                    <i class="fas fa-video-slash text-5xl text-gray-400 mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Video Mavjud Emas</h3>
                    <p class="text-gray-600">Bu dars uchun video hali yuklanmagan</p>
                </div>
                {% endif %}

                <!-- Lesson Tabs -->
                <div class="bg-white rounded-2xl shadow-lg mb-8" x-data="{ activeTab: 'content' }">
                    <!-- Tab Headers -->
                    <div class="flex border-b border-gray-200">
                        <button @click="activeTab = 'content'"
                                :class="activeTab === 'content' ? 'border-b-2 border-teal-600 text-teal-600' : 'text-gray-600 hover:text-gray-800'"
                                class="flex-1 py-4 px-6 font-semibold transition-colors">
                            <i class="fas fa-file-medical mr-2"></i>
                            Dars Materiallari
                        </button>
                        <button @click="activeTab = 'quizzes'"
                                :class="activeTab === 'quizzes' ? 'border-b-2 border-teal-600 text-teal-600' : 'text-gray-600 hover:text-gray-800'"
                                class="flex-1 py-4 px-6 font-semibold transition-colors">
                            <i class="fas fa-clipboard-check mr-2"></i>
                            Testlar
                            {% if quizzes %}
                                <span class="ml-2 px-2 py-1 bg-teal-100 text-teal-700 text-xs rounded-full">{{ quizzes.count }}</span>
                            {% endif %}
                        </button>
                        <button @click="activeTab = 'notes'"
                                :class="activeTab === 'notes' ? 'border-b-2 border-teal-600 text-teal-600' : 'text-gray-600 hover:text-gray-800'"
                                class="flex-1 py-4 px-6 font-semibold transition-colors">
                            <i class="fas fa-sticky-note mr-2"></i>
                            Eslatmalar
                        </button>
                    </div>

                    <!-- Tab Contents -->
                    <div class="p-6">
                        <!-- Content Tab -->
                        <div x-show="activeTab === 'content'" x-transition>
                            {% if lesson.description %}
                            <div class="mb-6">
                                <h3 class="text-lg font-bold text-gray-900 mb-3">Dars Tavsifi</h3>
                                <p class="text-gray-700 leading-relaxed">{{ lesson.description|linebreaks }}</p>
                            </div>
                            {% endif %}

                            {% if lesson.content %}
                            <div class="prose prose-lg max-w-none">
                                <h3 class="text-lg font-bold text-gray-900 mb-3">Dars Materiallari</h3>
                                <div class="bg-gray-50 rounded-xl p-6 text-gray-700">
                                    {{ lesson.content|safe|linebreaks }}
                                </div>
                            </div>
                            {% else %}
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-file-alt text-4xl mb-3"></i>
                                <p>Qo'shimcha materiallar hali mavjud emas</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Quizzes Tab -->
                        <div x-show="activeTab === 'quizzes'" x-transition>
                            {% if quizzes %}
                            <div class="space-y-4">
                                {% for quiz in quizzes %}
                                <div class="border border-gray-200 rounded-xl p-4 hover:border-teal-300 transition-all">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-900 mb-1">{{ quiz.title }}</h4>
                                            <p class="text-sm text-gray-600">{{ quiz.description|truncatewords:20 }}</p>
                                            <div class="flex items-center gap-4 mt-2 text-sm text-gray-500">
                                                <span>
                                                    <i class="fas fa-question-circle mr-1"></i>
                                                    {{ quiz.questions.count }} savol
                                                </span>
                                                <span>
                                                    <i class="fas fa-clock mr-1"></i>
                                                    {{ quiz.time_limit }} daqiqa
                                                </span>
                                                <span>
                                                    <i class="fas fa-percentage mr-1"></i>
                                                    O'tish balli: {{ quiz.passing_score }}%
                                                </span>
                                            </div>
                                        </div>
                                        <div class="ml-4 text-center">
                                            {% if is_enrolled %}
                                                {% with user|user_quiz_attempt:quiz as attempt %}
                                                    {% if attempt %}
                                                        <div class="mb-2">
                                                            <span class="text-2xl font-bold 
                                                                {% if attempt.is_passed %}text-green-600{% else %}text-red-600{% endif %}">
                                                                {{ attempt.score }}%
                                                            </span>
                                                            <p class="text-xs text-gray-500">Eng yaxshi natija</p>
                                                        </div>
                                                    {% endif %}
                                                {% endwith %}
                                                <a href="{% url 'quizzes:detail' quiz.id %}"
                                                   class="inline-block px-4 py-2 bg-gradient-to-r from-teal-600 to-cyan-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                                                    <i class="fas fa-play mr-1"></i>
                                                    {% if user|is_quiz_passed:quiz %}Qayta Yechish{% else %}Boshlash{% endif %}
                                                </a>
                                            {% else %}
                                                <button disabled class="px-4 py-2 bg-gray-300 text-gray-500 rounded-lg cursor-not-allowed">
                                                    <i class="fas fa-lock mr-1"></i>
                                                    Yopiq
                                                </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-clipboard-list text-4xl mb-3"></i>
                                <p>Bu dars uchun testlar mavjud emas</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Notes Tab -->
                        <div x-show="activeTab === 'notes'" x-transition>
                            <div class="space-y-4">
                                {% if is_enrolled %}
                                <!-- Add Note Form -->
                                <div class="bg-gray-50 rounded-xl p-4">
                                    <h4 class="font-semibold text-gray-900 mb-3">Yangi Eslatma Qo'shish</h4>
                                    <form method="POST" action="{% url 'lessons:notes' lesson.id %}">
                                        {% csrf_token %}
                                        <textarea name="note" 
                                                  rows="3" 
                                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                                                  placeholder="Dars bo'yicha eslatmalaringizni yozing..."></textarea>
                                        <button type="submit"
                                                class="mt-3 px-4 py-2 bg-gradient-to-r from-teal-600 to-cyan-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                                            <i class="fas fa-save mr-2"></i>
                                            Saqlash
                                        </button>
                                    </form>
                                </div>

                                <!-- Existing Notes -->
                                <div class="space-y-3">
                                    <!-- Sample Note -->
                                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                                        <div class="flex items-start justify-between">
                                            <div class="flex-1">
                                                <p class="text-gray-700 mb-2">Bu darsda o'rganilgan asosiy tushunchalarni takrorlash kerak.</p>
                                                <p class="text-xs text-gray-500">
                                                    <i class="fas fa-clock mr-1"></i>
                                                    2 kun oldin
                                                </p>
                                            </div>
                                            <button class="text-gray-400 hover:text-red-500 transition-colors">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="text-center py-8 text-gray-500">
                                    <i class="fas fa-lock text-4xl mb-3"></i>
                                    <p>Eslatmalar qo'shish uchun kursga yoziling</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex items-center justify-between">
                    {% if prev_lesson %}
                    <a href="{% url 'lessons:detail' course.id prev_lesson.id %}"
                       class="flex items-center px-6 py-3 bg-white border-2 border-gray-300 text-gray-700 rounded-xl font-semibold hover:border-teal-500 hover:text-teal-600 transition-all">
                        <i class="fas fa-chevron-left mr-2"></i>
                        <span class="hidden sm:inline">Oldingi Dars</span>
                        <span class="sm:hidden">Oldingi</span>
                    </a>
                    {% else %}
                    <div></div>
                    {% endif %}

                    {% if is_enrolled %}
                    <!-- Mark Complete Button -->
                    {% if not lesson_progress or not lesson_progress.is_completed %}
                    <button onclick="markLessonComplete({{ lesson.id }})"
                            class="px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all">
                        <i class="fas fa-check-circle mr-2"></i>
                        Tugallangan Deb Belgilash
                    </button>
                    {% endif %}
                    {% endif %}

                    {% if next_lesson %}
                    <a href="{% url 'lessons:detail' course.id next_lesson.id %}"
                       class="flex items-center px-6 py-3 bg-gradient-to-r from-teal-600 to-cyan-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all">
                        <span class="hidden sm:inline">Keyingi Dars</span>
                        <span class="sm:hidden">Keyingi</span>
                        <i class="fas fa-chevron-right ml-2"></i>
                    </a>
                    {% else %}
                    <a href="{% url 'courses:detail' course.id %}"
                       class="flex items-center px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all">
                        <i class="fas fa-trophy mr-2"></i>
                        Kursni Tugatish
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Sidebar -->
            <div class="lg:col-span-1">
                
                <!-- Course Info Card -->
                <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 sticky top-24">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Kurs Ma'lumotlari</h3>
                    
                    <!-- Course Title -->
                    <a href="{% url 'courses:detail' course.id %}"
                       class="block mb-4 text-teal-600 hover:text-teal-700 font-semibold">
                        {{ course.title }}
                    </a>

                    <!-- Course Progress -->
                    {% if is_enrolled %}
                    <div class="mb-6">
                        <div class="flex justify-between text-sm text-gray-600 mb-2">
                            <span>Umumiy Progress</span>
                            <span class="font-bold">{{ enrollment.progress|default:0 }}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-gradient-to-r from-teal-500 to-cyan-600 h-2 rounded-full transition-all duration-500"
                                 style="width: {{ enrollment.progress|default:0 }}%"></div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Instructor -->
                    <div class="flex items-center mb-6 pb-6 border-b border-gray-200">
                        {% user_avatar course.instructor 'w-10 h-10' %}
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">O'qituvchi</p>
                            <p class="font-semibold text-gray-900">{{ course.instructor.get_full_name|default:course.instructor.username }}</p>
                        </div>
                    </div>

                    <!-- Course Stats -->
                    <div class="space-y-3 text-sm">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">
                                <i class="fas fa-book mr-2"></i>
                                Jami Darslar
                            </span>
                            <span class="font-semibold text-gray-900">{{ course.lessons.count }}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">
                                <i class="fas fa-check-circle mr-2 text-green-500"></i>
                                Tugallangan
                            </span>
                            <span class="font-semibold text-gray-900">
                                {% if is_enrolled %}
                                    {{ user|completed_lessons_count:course }}
                                {% else %}
                                    0
                                {% endif %}
                            </span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">
                                <i class="fas fa-clipboard-check mr-2"></i>
                                Testlar
                            </span>
                            <span class="font-semibold text-gray-900">{{ quizzes.count|default:0 }}</span>
                        </div>
                    </div>
                </div>

                <!-- Lesson List -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Darslar Ro'yxati</h3>
                    
                    <div class="space-y-2 max-h-96 overflow-y-auto">
                        {% for course_lesson in course.lessons.all|dictsort:"order" %}
                        <a href="{% url 'lessons:detail' course.id course_lesson.id %}"
                           class="block px-3 py-2 rounded-lg transition-all
                                  {% if course_lesson.id == lesson.id %}
                                      bg-gradient-to-r from-teal-500 to-cyan-600 text-white
                                  {% else %}
                                      hover:bg-gray-50 text-gray-700
                                  {% endif %}">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center flex-1">
                                    <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold mr-2
                                                {% if course_lesson.id == lesson.id %}
                                                    bg-white bg-opacity-30
                                                {% else %}
                                                    bg-gray-200
                                                {% endif %}">
                                        {{ course_lesson.order }}
                                    </span>
                                    <span class="text-sm truncate">{{ course_lesson.title|truncatewords:4 }}</span>
                                </div>
                                {% if is_enrolled %}
                                    {% if user|is_lesson_completed:course_lesson %}
                                        <i class="fas fa-check-circle text-green-400 ml-2"></i>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Medical Download Resources -->
{% if lesson.content %}
<div class="bg-white py-8 border-t border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-download mr-3 text-indigo-600"></i>
                Yuklab Olish Uchun Materiallar
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Sample Resources -->
                <a href="#" class="flex items-center p-3 bg-white rounded-lg hover:shadow-md transition-all">
                    <i class="fas fa-file-pdf text-red-500 text-2xl mr-3"></i>
                    <div>
                        <p class="font-semibold text-gray-900">Dars Konspekti</p>
                        <p class="text-xs text-gray-500">PDF, 2.3 MB</p>
                    </div>
                </a>
                <a href="#" class="flex items-center p-3 bg-white rounded-lg hover:shadow-md transition-all">
                    <i class="fas fa-file-powerpoint text-orange-500 text-2xl mr-3"></i>
                    <div>
                        <p class="font-semibold text-gray-900">Prezentatsiya</p>
                        <p class="text-xs text-gray-500">PPTX, 5.1 MB</p>
                    </div>
                </a>
                <a href="#" class="flex items-center p-3 bg-white rounded-lg hover:shadow-md transition-all">
                    <i class="fas fa-file-archive text-blue-500 text-2xl mr-3"></i>
                    <div>
                        <p class="font-semibold text-gray-900">Qo'shimcha Fayllar</p>
                        <p class="text-xs text-gray-500">ZIP, 8.7 MB</p>
                    </div>
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

<script>
// Video Player Controls
let videoPlayer = null;
let currentTimeInterval = null;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize video tracking
    const iframe = document.querySelector('iframe');
    if (iframe) {
        startVideoTracking();
    }
});

// Start tracking video progress
function startVideoTracking() {
    let watchedSeconds = 0;
    
    currentTimeInterval = setInterval(() => {
        watchedSeconds++;
        
        // Update progress every 10 seconds
        if (watchedSeconds % 10 === 0) {
            updateLessonProgress(watchedSeconds);
        }
        
        // Update current time display
        updateCurrentTime(watchedSeconds);
    }, 1000);
}

// Update current time display
function updateCurrentTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    const display = `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    
    const currentTimeEl = document.getElementById('currentTime');
    if (currentTimeEl) {
        currentTimeEl.textContent = display;
    }
}

// Update lesson progress via AJAX
function updateLessonProgress(watchedSeconds) {
    fetch(`{% url 'lessons:update_progress' lesson.id %}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `watched_duration=${watchedSeconds}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.is_completed) {
            showCompletionMessage();
        }
    })
    .catch(error => console.error('Error updating progress:', error));
}

// Mark lesson as complete
function markLessonComplete(lessonId) {
    fetch(`{% url 'lessons:complete' lesson.id %}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMedicalToast(data.message || 'Dars tugallandi!', 'success');
            
            // Update UI
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMedicalToast('Xatolik yuz berdi!', 'error');
    });
}

// Show completion message
function showCompletionMessage() {
    const message = document.createElement('div');
    message.className = 'fixed bottom-8 right-8 bg-green-600 text-white px-6 py-3 rounded-xl shadow-2xl flex items-center z-50 animate-slide-up';
    message.innerHTML = `
        <i class="fas fa-check-circle mr-3 text-2xl"></i>
        <div>
            <p class="font-bold">Tabriklaymiz!</p>
            <p class="text-sm">Dars muvaffaqiyatli tugallandi</p>
        </div>
    `;
    
    document.body.appendChild(message);
    
    setTimeout(() => {
        message.classList.add('animate-fade-out');
        setTimeout(() => message.remove(), 500);
    }, 5000);
}

// Video control functions
function togglePlay() {
    // Placeholder for actual video control
    console.log('Toggle play/pause');
}

function rewind() {
    // Placeholder for rewind functionality
    console.log('Rewind 10 seconds');
}

function forward() {
    // Placeholder for forward functionality
    console.log('Forward 10 seconds');
}

function toggleFullscreen() {
    const iframe = document.querySelector('iframe');
    if (iframe) {
        if (iframe.requestFullscreen) {
            iframe.requestFullscreen();
        } else if (iframe.webkitRequestFullscreen) {
            iframe.webkitRequestFullscreen();
        } else if (iframe.msRequestFullscreen) {
            iframe.msRequestFullscreen();
        }
    }
}

// Clean up on page unload
window.addEventListener('beforeunload', () => {
    if (currentTimeInterval) {
        clearInterval(currentTimeInterval);
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Space bar to play/pause
    if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
        e.preventDefault();
        togglePlay();
    }
    
    // Arrow keys for navigation
    if (e.code === 'ArrowLeft') {
        rewind();
    }
    if (e.code === 'ArrowRight') {
        forward();
    }
    
    // F for fullscreen
    if (e.code === 'KeyF') {
        toggleFullscreen();
    }
});

// Auto-save notes
let noteTimeout;
const noteTextarea = document.querySelector('textarea[name="note"]');
if (noteTextarea) {
    noteTextarea.addEventListener('input', function() {
        clearTimeout(noteTimeout);
        noteTimeout = setTimeout(() => {
            // Auto-save logic here
            console.log('Auto-saving note...');
        }, 2000);
    });
}
</script>
{% endblock %}